{% extends "_base.html" %}
{% block content %}
{% for match in matches %}
<!-- match -->
<div class="card text-center m-2">
   <div class="card-body container match-container">
      <!-- match detail -->
      <div class="row align-items-center">
         <div class="col" {% if match.a["lose"] %} style="color:gray" {% endif %}>
            <div class="team">{{ match.a["team"] }}</div>
          {% if match.a["auction_gambler"] %}
            <small>{{ match.a["auction_gambler"] }}</small>
          {% endif %}
            <div class="score">
               {% if match.a["score"] is none %} - {% else %} {{ match.a["score"] }} {% endif %}
            </div>
         </div>
         <div class="col text-nowrap">
            <div>{{ match.match_time.strftime('%Y-%m-%d') }}</div>
            <div>{{ match.match_time.strftime('%H:%M') }}</div>
            <small>盘口</small>
            <div>{{ match.handicap_display or "-" }}</div>
         </div>
         <div class="col" {% if match.b["lose"] %} style="color:gray" {% endif %}>
            <div class="team">{{ match.b["team"] }}</div>
          {% if match.b["auction_gambler"] %}
            <small>{{ match.b["auction_gambler"] }}</small>
          {% endif %}
            <div class="score">
               {% if match.b["score"] is none %} - {% else %} {{ match.b["score"] }} {% endif %}
            </div>
         </div>
      </div>
      <hr>
      <!-- bet detail -->
      <div class="row align-items-center">
        <div class="col">
        {% for gambler in match.a["gamblers"] %}
          <div>{{ gambler }}</div>
        {% endfor %}
        </div>
        <div class="col">
            <p class="countdown" data-cutoff-bet="{{ match.bet_cutoff_time.timestamp() }}" data-cutoff-handicap="{{ match.handicap_cutoff_time.timestamp() }}" ></p>
        </div>
        <div class="col">
        {% for gambler in match.b["gamblers"] %}
          <div>{{ gambler }}</div>
        {% endfor %}
        </div>
      </div>
      <hr>
      <!-- action -->
      <form action="/" method="post">
        <div class="row align-items-center">
          <input type="hidden" name="match_id" value="{{ match.id }}">
          <div class="col">
            <button class="btn btn-primary bet-button" type="submit" name="betchoice" value="a"{% if not match.can_bet() or g.me.name in match.a["gamblers"] %} disabled="true"{% endif %}>投注</button>
          </div>
	        <div class="col"></div>
          <div class="col">
            <button class="btn btn-primary bet-button" type="submit" name="betchoice" value="b"{% if not match.can_bet() or g.me.name in match.b["gamblers"] %} disabled="true"{% endif %}>投注</button>
          </div>
        </div>
      </form>
   </div>
</div>
{% endfor %}
<script>
function deactivateButtons(match) {
  Array.from(match.getElementsByClassName("bet-button")).forEach(function (button) {
    button.disabled = true;
  })
}

function renderCountdown(countdown, distance, announcement) {
  // Time calculations for days, hours, minutes and seconds
  var hours = Math.floor((distance % (60 * 60 * 24)) / (60 * 60));
  var minutes = Math.floor((distance % (60 * 60)) / (60));
  var seconds = Math.floor((distance % 60));

  // Display the result in the element
  countdown.innerHTML = announcement
  countdown.innerHTML += (hours >= 0 ? (hours >= 10 ? hours : "0" + hours) + ":" : "")
  countdown.innerHTML += (minutes >= 0 ? (minutes >= 10 ? minutes : "0" + minutes) + ":" : "")
  countdown.innerHTML += (seconds >= 0 ? (seconds >= 10 ? seconds : "0" + seconds) : "");
}

// setup countdown for each match container
Array.from(document.getElementsByClassName("match-container")).forEach(function (match) {
  var countdown = match.getElementsByClassName("countdown")[0];

  // update the count down every 1 second
  var x = setInterval(function () {
    var utcnow = (new Date()).getTime() / 1000.0;
    var cutoffBet = countdown.getAttribute("data-cutoff-bet");
    var cutoffHandcap = countdown.getAttribute("data-cutoff-handicap")

    if (utcnow < cutoffHandcap) {
      renderCountdown(countdown, cutoffHandcap - utcnow, "<small>盘口未定<br>距投注开始还有<br></small>")
      deactivateButtons(match);
    } else if (utcnow < cutoffBet) {
      renderCountdown(countdown, cutoffBet - utcnow, "<small>距投注结束还有<br></small>")
    } else {
      clearInterval(x);
      // countdown.innerHTML = "投注已结束";
      deactivateButtons(match);
    }
  }, 1000)
})
</script>
{% endblock %}
